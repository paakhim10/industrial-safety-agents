<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmolVLM Testing for AI4Safety</title>
    <style>
      body {
        font-family: "Siemens Sans", Arial, Helvetica, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background-color: #f5f5f5; /* Siemens light grey */
        color: #333333; /* Siemens dark grey */
      }

      .controls,
      .io-areas,
      .video-controls,
      .logging-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        background-color: #ffffff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .io-areas {
        flex-direction: column;
        align-items: stretch;
      }

      .video-controls,
      .logging-controls {
        flex-wrap: wrap;
        justify-content: center;
      }

      textarea {
        width: 300px;
        height: 80px;
        padding: 8px;
        border: 1px solid #cccccc;
        border-radius: 4px;
        font-size: 14px;
        font-family: "Siemens Sans", Arial, Helvetica, sans-serif;
      }

      #videoFeed {
        width: 480px;
        height: 360px;
        border: 2px solid #333333; /* Siemens dark grey */
        background-color: #000;
        border-radius: 8px;
      }

      #startButton,
      .video-btn,
      .log-btn {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        color: white;
        font-family: "Siemens Sans", Arial, Helvetica, sans-serif;
        transition: background-color 0.3s ease;
      }

      #startButton.start {
        background-color: #64a70b; /* Siemens green */
      }

      #startButton.stop {
        background-color: #e60000; /* Siemens red */
      }

      .video-btn {
        background-color: #009999; /* Siemens cyan */
      }

      .video-btn:hover {
        background-color: #006699; /* Siemens accent blue */
      }

      .video-btn:disabled,
      .log-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }

      .log-btn {
        background-color: #ff6600; /* Orange for logging actions */
      }

      .log-btn:hover {
        background-color: #cc5200;
      }

      label {
        font-weight: bold;
        color: #333333;
      }

      select,
      input[type="file"] {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #cccccc;
        font-family: "Siemens Sans", Arial, Helvetica, sans-serif;
      }

      .hidden {
        display: none;
      }

      .video-info,
      .log-info {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin: 5px 0;
        font-size: 14px;
        color: #333333;
      }

      .log-info {
        background-color: #fff3cd;
        color: #856404;
      }

      #responseLog {
        width: 100%;
        height: 150px;
        font-family: monospace;
        font-size: 12px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <h1>Real-time SmolVLM Testing for AI4Safety</h1>

    <div class="video-controls">
      <input type="file" id="videoFile" accept="video/*" />
      <button class="video-btn" id="loadVideoBtn">Load Video</button>
      <button class="video-btn" id="playPauseBtn" disabled>Play</button>
      <button class="video-btn" id="restartBtn" disabled>Restart</button>
    </div>

    <div class="video-info" id="videoInfo">No video loaded</div>

    <video id="videoFeed" controls muted></video>
    <canvas id="canvas" class="hidden"></canvas>
    <!-- For capturing frames -->

    <div class="io-areas">
      <div>
        <label for="baseURL">Base API:</label><br />
        <input id="baseURL" name="Instruction" value="http://localhost:8080" />
      </div>
      <div>
        <label for="instructionText">Instruction:</label><br />
        <textarea
          id="instructionText"
          style="height: 2em; width: 40em"
          name="Instruction"
        ></textarea>
      </div>
      <div>
        <label for="responseText">Current Response:</label><br />
        <textarea
          id="responseText"
          style="height: 2em; width: 40em"
          name="Response"
          readonly
          placeholder="Server response will appear here..."
        ></textarea>
      </div>
    </div>

    <div class="logging-controls">
      <button class="log-btn" id="downloadJsonBtn" disabled>
        Download Log as JSON
      </button>
      <button class="log-btn" id="clearLogBtn" disabled>Clear Log</button>
      <span class="log-info" id="logInfo">No responses logged yet</span>
    </div>

    <div class="controls">
      <label for="intervalSelect">Interval between 2 requests:</label>
      <select id="intervalSelect" name="Interval between 2 requests">
        <option value="100">100ms</option>
        <option value="250">250ms</option>
        <option value="500">500ms</option>
        <option value="1000" selected>1s</option>
        <option value="2000">2s</option>
      </select>
      <button id="startButton" class="start" disabled>Start Processing</button>
    </div>

    <script>
      const video = document.getElementById("videoFeed");
      const canvas = document.getElementById("canvas");
      const baseURL = document.getElementById("baseURL");
      const instructionText = document.getElementById("instructionText");
      const responseText = document.getElementById("responseText");
      const responseLog = document.getElementById("responseLog");
      const intervalSelect = document.getElementById("intervalSelect");
      const startButton = document.getElementById("startButton");
      const videoFile = document.getElementById("videoFile");
      const loadVideoBtn = document.getElementById("loadVideoBtn");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const restartBtn = document.getElementById("restartBtn");
      const videoInfo = document.getElementById("videoInfo");
      const downloadJsonBtn = document.getElementById("downloadJsonBtn");
      const clearLogBtn = document.getElementById("clearLogBtn");
      const logInfo = document.getElementById("logInfo");

      instructionText.value =
        "You are a safety inspector. Examine this video for workplace safety violations. Report: 1) Missing PPE (hardhats, safety vests, safety boots), 2) Restricted area violations, 3) Unsafe vehicle-pedestrian distances. Be specific about what you observe.";
      let intervalId;
      let isProcessing = false;
      let videoLoaded = false;
      let responseHistory = []; // Array to store all responses
      let sessionStartTime = null;

      // Returns response text (string)
      async function sendChatCompletionRequest(instruction, imageBase64URL) {
        const response = await fetch(`${baseURL.value}/v1/chat/completions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            max_tokens: 100,
            messages: [
              {
                role: "user",
                content: [
                  { type: "text", text: instruction },
                  {
                    type: "image_url",
                    image_url: {
                      url: imageBase64URL,
                    },
                  },
                ],
              },
            ],
          }),
        });
        if (!response.ok) {
          const errorData = await response.text();
          return `Server error: ${response.status} - ${errorData}`;
        }
        const data = await response.json();
        return data.choices[0].message.content;
      }

      function addToLog(timestamp, videoTime, instruction, response) {
        const logEntry = {
          timestamp: new Date(timestamp).toISOString(),
          videoTime: videoTime,
          instruction: instruction,
          response: response,
          sessionTime: sessionStartTime ? timestamp - sessionStartTime : 0,
        };

        responseHistory.push(logEntry);

        // Update log info
        logInfo.textContent = `${responseHistory.length} responses logged`;

        // Enable download buttons
        downloadJsonBtn.disabled = false;
        clearLogBtn.disabled = false;
      }

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
      }

      function downloadTextLog() {
        if (responseHistory.length === 0) {
          alert("No responses to download.");
          return;
        }

        const videoName = videoFile.files[0]?.name || "unknown_video";
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `smolvlm_log_${videoName}_${timestamp}.txt`;

        let content = `SmolVLM Response Log\n`;
        content += `Video: ${videoName}\n`;
        content += `Session started: ${new Date(
          sessionStartTime
        ).toISOString()}\n`;
        content += `Total responses: ${responseHistory.length}\n`;
        content += `Instruction: "${responseHistory[0]?.instruction}"\n\n`;
        content += "=" * 50 + "\n\n";

        responseHistory.forEach((entry, index) => {
          content += `Response ${index + 1}:\n`;
          content += `Timestamp: ${entry.timestamp}\n`;
          content += `Video Time: ${formatTime(entry.videoTime)}\n`;
          content += `Response: ${entry.response}\n\n`;
        });

        downloadFile(content, filename, "text/plain");
      }

      function downloadJsonLog() {
        if (responseHistory.length === 0) {
          alert("No responses to download.");
          return;
        }

        const videoName = videoFile.files[0]?.name || "unknown_video";
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const filename = `smolvlm_log_${videoName}_${timestamp}.json`;

        const logData = {
          metadata: {
            video: videoName,
            sessionStart: new Date(sessionStartTime).toISOString(),
            totalResponses: responseHistory.length,
            instruction: responseHistory[0]?.instruction,
          },
          responses: responseHistory,
        };

        const content = JSON.stringify(logData, null, 2);
        downloadFile(content, filename, "application/json");
      }

      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function clearLog() {
        if (confirm("Are you sure you want to clear the response log?")) {
          responseHistory = [];
          logInfo.textContent = "No responses logged yet";
          downloadJsonBtn.disabled = true;
          clearLogBtn.disabled = true;
        }
      }

      function loadVideo() {
        const file = videoFile.files[0];
        if (!file) {
          alert("Please select a video file first.");
          return;
        }

        const url = URL.createObjectURL(file);
        video.src = url;

        video.addEventListener("loadedmetadata", () => {
          videoLoaded = true;
          playPauseBtn.disabled = false;
          restartBtn.disabled = false;
          startButton.disabled = false;

          const duration = Math.floor(video.duration);
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          videoInfo.textContent = `Video loaded: ${
            file.name
          } (${minutes}:${seconds.toString().padStart(2, "0")})`;
          responseText.value =
            "Video loaded successfully. You can now play it and start processing.";
        });

        video.addEventListener("error", (e) => {
          console.error("Video loading error:", e);
          responseText.value = `Error loading video: ${e.message}`;
          videoLoaded = false;
        });
      }

      function togglePlayPause() {
        if (video.paused) {
          video.play();
          playPauseBtn.textContent = "Pause";
        } else {
          video.pause();
          playPauseBtn.textContent = "Play";
        }
      }

      function restartVideo() {
        video.currentTime = 0;
        if (!video.paused) {
          video.play();
        }
      }

      function captureFrame() {
        if (!videoLoaded || video.videoWidth === 0) {
          console.warn("Video not ready for capture.");
          return null;
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL("image/jpeg", 0.8);
      }

      async function processFrame() {
        if (!isProcessing || video.paused || video.ended) return;

        const instruction = instructionText.value;
        const imageBase64URL = captureFrame();

        if (!imageBase64URL) {
          responseText.value =
            "Failed to capture frame. Video might not be ready.";
          return;
        }

        try {
          const response = await sendChatCompletionRequest(
            instruction,
            imageBase64URL
          );
          const currentTime = Math.floor(video.currentTime);
          const timestamp = Date.now();
          const minutes = Math.floor(currentTime / 60);
          const seconds = currentTime % 60;

          const displayText = `[${minutes}:${seconds
            .toString()
            .padStart(2, "0")}] ${response}`;

          responseText.value = displayText;

          // Add to log
          addToLog(timestamp, video.currentTime, instruction, response);
        } catch (error) {
          console.error("Error processing frame:", error);
          responseText.value = `Error: ${error.message}`;
        }
      }

      function handleStartProcessing() {
        if (!videoLoaded) {
          responseText.value = "No video loaded. Please load a video first.";
          return;
        }

        isProcessing = true;
        sessionStartTime = Date.now();
        startButton.textContent = "Stop Processing";
        startButton.classList.remove("start");
        startButton.classList.add("stop");

        instructionText.disabled = true;
        intervalSelect.disabled = true;
        loadVideoBtn.disabled = true;
        videoFile.disabled = true;

        responseText.value = "Frame processing started...";

        const intervalMs = parseInt(intervalSelect.value, 10);

        // Initial immediate call
        processFrame();

        // Then set interval
        intervalId = setInterval(processFrame, intervalMs);
      }

      function handleStopProcessing() {
        isProcessing = false;
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
        startButton.textContent = "Start Processing";
        startButton.classList.remove("stop");
        startButton.classList.add("start");

        instructionText.disabled = false;
        intervalSelect.disabled = false;
        loadVideoBtn.disabled = false;
        videoFile.disabled = false;

        if (responseText.value.startsWith("Frame processing started...")) {
          responseText.value = "Frame processing stopped.";
        }
      }

      // Event listeners
      loadVideoBtn.addEventListener("click", loadVideo);
      playPauseBtn.addEventListener("click", togglePlayPause);
      restartBtn.addEventListener("click", restartVideo);
      downloadJsonBtn.addEventListener("click", downloadJsonLog);
      clearLogBtn.addEventListener("click", clearLog);

      video.addEventListener("play", () => {
        playPauseBtn.textContent = "Pause";
      });

      video.addEventListener("pause", () => {
        playPauseBtn.textContent = "Play";
      });

      video.addEventListener("ended", () => {
        playPauseBtn.textContent = "Play";
        if (isProcessing) {
          responseText.value = "Video ended. Processing stopped.";
          handleStopProcessing();
        }
      });

      startButton.addEventListener("click", () => {
        if (isProcessing) {
          handleStopProcessing();
        } else {
          handleStartProcessing();
        }
      });

      // Initialize
      responseText.value = "Please load a video file to begin.";
    </script>
  </body>
</html>
